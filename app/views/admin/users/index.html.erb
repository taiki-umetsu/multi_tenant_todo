<div class="max-w-6xl mx-auto p-6">
  <div class="bg-white rounded-lg shadow-md p-6 space-y-8">
    <!-- ページタイトル -->
    <div data-controller="modal">
      <div class="flex items-center justify-between mb-2">
        <div>
          <h1 class="text-3xl font-bold text-gray-900">ユーザー管理</h1>
        </div>
        <%= render ButtonComponent.new(
          text: "招待",
          type: :primary,
          "data-action": "click->modal#open"
        ) %>
      </div>

      <!-- 招待モーダル -->
      <div id="invitation-modal"
           class="hidden modal-overlay"
           data-modal-target="modal"
           data-action="click->modal#close">
        <div class="modal-content" data-action="click->modal#stopPropagation">
          <div class="modal-header">
            <h3 class="modal-title">ユーザー招待</h3>
            <button type="button"
                    class="modal-close-btn"
                    data-action="click->modal#close">
              <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>

          <div>
            <%= form_with model: [:admin, UserInvitation.new], class: "modal-form" do |form| %>
                <%= render FormFieldComponent.new(
                  form: form,
                  field_name: :email,
                  label_text: "メールアドレス",
                  field_type: :email_field
                ) %>

                <%= render FormFieldComponent.new(
                  form: form,
                  field_name: :role,
                  label_text: "権限",
                  field_type: :select,
                  options: options_for_select([["メンバー", "member"], ["管理者", "admin"]], "member")
                ) %>

              <div class="modal-actions">
                <%= render SubmitButtonComponent.new(text: "招待URLを作成", disable_with: "送信中...") %>
              </div>
            <% end %>
          </div>

          <div id="invitation_result"></div>
        </div>
      </div>
    </div>

    <!-- 招待中ユーザー表示 -->
    <div>
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-gray-900">招待中のユーザー</h2>
        <div class="text-sm text-gray-500">
          <%= @invitations.count %>件
        </div>
      </div>

      <% if @invitations.any? %>
        <%= render(TableComponent.new(
          headers: [
            { label: "メールアドレス", width: "w-1/4" },
            { label: "権限", width: "w-1/6" },
            { label: "招待日", width: "w-1/6" },
            { label: "ステータス", width: "w-1/6" },
            { label: "招待URL", width: "w-1/4" }
          ],
          rows: @invitations.map do |invitation|
            invitation_url = new_user_url(token: invitation.token)
            [
              { content: invitation.email, type: :text },
              {
                content: invitation.admin? ? "管理者" : "メンバー",
                type: invitation.admin? ? :badge_success : :badge_info
              },
              { content: l(invitation.created_at.to_date, format: :long), type: :date },
              {
                content: invitation.expired? ? "期限切れ" : "有効",
                type: invitation.expired? ? :badge_yellow : :badge_success
              },
              {
                content: content_tag(:div,
                  render(ButtonComponent.new(
                    text: "URLをコピー",
                    type: :secondary,
                    data: {
                      clipboard_target: "button",
                      action: "click->clipboard#copy"
                    }
                  )),
                  data: {
                    controller: "clipboard",
                    clipboard_text_value: invitation_url
                  }
                )
              }
            ]
          end,
          empty_message: "招待中のユーザーはいません"
        )) %>
      <% else %>
        <div class="text-center py-8 text-gray-500">
          招待中のユーザーはいません
        </div>
      <% end %>
    </div>

    <!-- ユーザー一覧表示 -->
    <div>
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-gray-900">登録済みユーザー</h2>
        <div class="text-sm text-gray-500">
          <%= @users.count %>件
        </div>
      </div>

      <%= render(TableComponent.new(
        headers: [
          { label: "メールアドレス", width: "w-1/2" },
          { label: "権限", width: "w-1/4" },
          { label: "登録日", width: "w-1/4" }
        ],
        rows: @users.map do |user|
          [
            { content: user.email, type: :text },
            {
              content: user.admin? ? "管理者" : "メンバー",
              type: user.admin? ? :badge_success : :badge_info
            },
            { content: l(user.created_at.to_date, format: :long), type: :date }
          ]
        end,
        empty_message: "登録済みユーザーはいません"
      )) %>
    </div>
  </div>
</div>
